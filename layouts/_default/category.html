{{ partial "header.html" . }}

{{ if not .IsHome }}
<h1>{{ .Title | markdownify }}</h1>
{{ end }}

{{ partial "work_in_progress.html" . }}

{{ .Content }}

<!-- Get all projects from the projects section -->
{{ $allProjects := where site.RegularPages "Section" "projects" }}

<!-- First filter: separate active and discontinued projects -->
{{ $activeProjects := slice }}
{{ $discontinuedProjects := slice }}

{{ range $allProjects }}
  {{ $status := .Params.status | default "active" }}
  {{ if eq $status "discontinued" }}
    {{ $discontinuedProjects = $discontinuedProjects | append . }}
  {{ else }}
    {{ $activeProjects = $activeProjects | append . }}
  {{ end }}
{{ end }}

<!-- Get priority order for focus areas from page params, with fallback -->
{{ $priorityFocusAreas := .Params.priority_focus_areas | default (slice "Long Term Project" "Security Tools" "Security Research" "Developer Tools" "AI & Automation") }}

<!-- Second filter: group active projects by focus_area -->
{{ $focusGroups := dict }}

{{ range $activeProjects }}
  {{ $focusArea := .Params.focus_area | default "Other" }}
  {{ $existingGroup := index $focusGroups $focusArea }}
  {{ if $existingGroup }}
    {{ $focusGroups = merge $focusGroups (dict $focusArea ($existingGroup | append .)) }}
  {{ else }}
    {{ $focusGroups = merge $focusGroups (dict $focusArea (slice .)) }}
  {{ end }}
{{ end }}

<!-- Separate priority focus areas from others -->
{{ $priorityKeys := slice }}
{{ $remainingKeys := slice }}

{{ range $key, $value := $focusGroups }}
  {{ if in $priorityFocusAreas $key }}
    {{ $priorityKeys = $priorityKeys | append $key }}
  {{ else }}
    {{ $remainingKeys = $remainingKeys | append $key }}
  {{ end }}
{{ end }}

<!-- Sort priority keys by their order in the priority array -->
{{ $orderedPriorityKeys := slice }}
{{ range $priorityArea := $priorityFocusAreas }}
  {{ if in $priorityKeys $priorityArea }}
    {{ $orderedPriorityKeys = $orderedPriorityKeys | append $priorityArea }}
  {{ end }}
{{ end }}

<!-- Sort remaining keys alphabetically -->
{{ $remainingKeys = sort $remainingKeys }}

<!-- Combine ordered priority keys with remaining keys -->
{{ $focusKeys := $orderedPriorityKeys }}
{{ range $remainingKey := $remainingKeys }}
  {{ $focusKeys = $focusKeys | append $remainingKey }}
{{ end }}

<!-- Display focus areas in priority order, then alphabetically -->
{{ range $focusKey := $focusKeys }}
  {{ $projects := index $focusGroups $focusKey }}
  {{ if $projects }}
    <div class="project-section-header">
      <h2 class="project-section-title">{{ $focusKey }}</h2>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {{ range $projects }}
        <div id="featured_home">
          <center>
            <a href="{{ .RelPermalink }}">
              <b>{{ .Title }}</b>
              <br />
              {{ if .Params.featured_image }}
                {{ $img := resources.Get .Params.featured_image }}
                {{ if $img }}
                  {{ if eq $img.MediaType.SubType "svg" }}
                    <img src="{{ $img.RelPermalink }}" alt="Image for {{ .Title }}" class="img_gadget project-list-image-svg" />
                  {{ else }}
                    <img src="{{ ($img.Resize "x200 q100").RelPermalink }}" alt="Image for {{ .Title }}" class="img_gadget project-list-image-regular" />
                  {{ end }}
                {{ else }}
                  {{ $placeholder := resources.Get "images/project-placeholder.svg" }}
                  {{ if $placeholder }}
                    <img src="{{ $placeholder.RelPermalink }}" alt="Placeholder for {{ .Title }}" class="img_gadget project-list-image-svg" style="opacity: 0.7;" />
                  {{ else }}
                    <p>No Image</p>
                  {{ end }}
                {{ end }}
              {{ else }}
                {{ $img_loc := printf "%s.*" ( replace .Path "projects" "images/projects" ) }}
                {{ $img_found := resources.GetMatch $img_loc }}
                {{ if $img_found }}
                  {{ if eq $img_found.MediaType.SubType "svg" }}
                    <img src="{{ $img_found.RelPermalink }}" alt="Image for {{ $.Title }}" class="img_gadget project-list-image-square" />
                  {{ else }}
                    <img src="{{ ($img_found.Resize "x180 q100").RelPermalink }}" alt="Image for {{ $.Title }}" class="img_gadget" />
                  {{ end }}
                {{ else }}
                  {{ $placeholder := resources.Get "images/project-placeholder.svg" }}
                  {{ if $placeholder }}
                    <img src="{{ $placeholder.RelPermalink }}" alt="Placeholder for {{ $.Title }}" class="img_gadget project-list-image-svg" style="opacity: 0.7;" />
                  {{ else }}
                    {{ $.Title }}
                  {{ end }}
                {{ end }}
                <br />
              {{ end }}
              <br />
            </a>
          </center>
          <div class="project-links">
            {{ if .Params.website_url }}
              <a href="{{ .Params.website_url }}" target="_blank" rel="noopener" title="Website">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
              </a>
            {{ end }}
            {{ if .Params.github_url }}
              <a href="{{ .Params.github_url }}" target="_blank" rel="noopener" title="GitHub">
                {{ $githubIcon := resources.Get "images/github.svg" }}
                {{ if $githubIcon }}
                  <img src="{{ $githubIcon.RelPermalink }}" alt="GitHub" style="width: 20px; height: 20px;" />
                {{ end }}
              </a>
            {{ end }}
          </div>
        </div>
      {{ end }}
      <div class="clear"></div>
    </div>
  {{ end }}
{{ end }}

<!-- Display discontinued projects section -->
{{ if $discontinuedProjects }}
  <div class="project-section-header">
    <h2 class="project-section-title">{{ $.Site.Params.navigation.labels.discontinued_projects | default "Discontinued Projects" }}</h2>
    <p style="color: #666; font-style: italic; margin-bottom: 20px;">
      {{ $.Site.Params.navigation.labels.discontinued_project_description | default "The following projects are no longer actively maintained or developed, sorted by discontinuation date." }}
    </p>
  </div>
  
  <!-- Separate discontinued projects with and without dates -->
  {{ $discontinuedWithDates := slice }}
  {{ $discontinuedWithoutDates := slice }}
  
  {{ range $discontinuedProjects }}
    {{ if .Params.discontinue_date }}
      {{ $discontinuedWithDates = $discontinuedWithDates | append . }}
    {{ else }}
      {{ $discontinuedWithoutDates = $discontinuedWithoutDates | append . }}
    {{ end }}
  {{ end }}
  
  <!-- Sort projects with dates by discontinue_date (most recent first) -->
  {{ $sortedDiscontinuedWithDates := sort $discontinuedWithDates ".Params.discontinue_date" "desc" }}
  
  <!-- Sort projects without dates alphabetically by title -->
  {{ $sortedDiscontinuedWithoutDates := sort $discontinuedWithoutDates ".Title" }}
  
  <!-- Display discontinued projects with dates first -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {{ range $sortedDiscontinuedWithDates }}
      <div id="featured_home" style="opacity: 0.7;">
        <center>
          <a href="{{ .RelPermalink }}">
            <b>{{ .Title }}</b>
            {{ if .Params.discontinue_date }}
              <br />
              <small style="color: #666;">Discontinued: {{ dateFormat "January 2006" .Params.discontinue_date }}</small>
            {{ end }}
            <br />
            {{ if .Params.featured_image }}
              {{ $img := resources.Get .Params.featured_image }}
              {{ if $img }}
                {{ if eq $img.MediaType.SubType "svg" }}
                  <img src="{{ $img.RelPermalink }}" alt="Image for {{ .Title }}" class="img_gadget project-list-image-svg" />
                {{ else }}
                  <img src="{{ ($img.Resize "x200 q100").RelPermalink }}" alt="Image for {{ .Title }}" class="img_gadget project-list-image-regular" />
                {{ end }}
              {{ else }}
                {{ $placeholder := resources.Get "images/project-placeholder.svg" }}
                {{ if $placeholder }}
                  <img src="{{ $placeholder.RelPermalink }}" alt="Placeholder for {{ .Title }}" class="img_gadget project-list-image-svg" style="opacity: 0.7;" />
                {{ else }}
                  <p>No Image</p>
                {{ end }}
              {{ end }}
            {{ else }}
              {{ $img_loc := printf "%s.*" ( replace .Path "projects" "images/projects" ) }}
              {{ $img_found := resources.GetMatch $img_loc }}
              {{ if $img_found }}
                {{ if eq $img_found.MediaType.SubType "svg" }}
                  <img src="{{ $img_found.RelPermalink }}" alt="Image for {{ $.Title }}" class="img_gadget project-list-image-square" />
                {{ else }}
                  <img src="{{ ($img_found.Resize "x180 q100").RelPermalink }}" alt="Image for {{ $.Title }}" class="img_gadget" />
                {{ end }}
              {{ else }}
                {{ $placeholder := resources.Get "images/project-placeholder.svg" }}
                {{ if $placeholder }}
                  <img src="{{ $placeholder.RelPermalink }}" alt="Placeholder for {{ $.Title }}" class="img_gadget project-list-image-svg" style="opacity: 0.7;" />
                {{ else }}
                  {{ $.Title }}
                {{ end }}
              {{ end }}
              <br />
            {{ end }}
            <br />
          </a>
        </center>
        <div class="project-links">
          {{ if .Params.website_url }}
            <a href="{{ .Params.website_url }}" target="_blank" rel="noopener" title="Website">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
            </a>
          {{ end }}
          {{ if .Params.github_url }}
            <a href="{{ .Params.github_url }}" target="_blank" rel="noopener" title="GitHub">
              {{ $githubIcon := resources.Get "images/github.svg" }}
              {{ if $githubIcon }}
                <img src="{{ $githubIcon.RelPermalink }}" alt="GitHub" style="width: 20px; height: 20px;" />
              {{ end }}
            </a>
          {{ end }}
        </div>
      </div>
    {{ end }}
    
    <!-- Display discontinued projects without dates after those with dates -->
    {{ range $sortedDiscontinuedWithoutDates }}
      <div id="featured_home" style="opacity: 0.7;">
        <center>
          <a href="{{ .RelPermalink }}">
            <b>{{ .Title }}</b>
            <br />
            {{ if .Params.featured_image }}
              {{ $img := resources.Get .Params.featured_image }}
              {{ if $img }}
                {{ if eq $img.MediaType.SubType "svg" }}
                  <img src="{{ $img.RelPermalink }}" alt="Image for {{ .Title }}" class="img_gadget project-list-image-svg" />
                {{ else }}
                  <img src="{{ ($img.Resize "x200 q100").RelPermalink }}" alt="Image for {{ .Title }}" class="img_gadget project-list-image-regular" />
                {{ end }}
              {{ else }}
                {{ $placeholder := resources.Get "images/project-placeholder.svg" }}
                {{ if $placeholder }}
                  <img src="{{ $placeholder.RelPermalink }}" alt="Placeholder for {{ .Title }}" class="img_gadget project-list-image-svg" style="opacity: 0.7;" />
                {{ else }}
                  <p>No Image</p>
                {{ end }}
              {{ end }}
            {{ else }}
              {{ $img_loc := printf "%s.*" ( replace .Path "projects" "images/projects" ) }}
              {{ $img_found := resources.GetMatch $img_loc }}
              {{ if $img_found }}
                {{ if eq $img_found.MediaType.SubType "svg" }}
                  <img src="{{ $img_found.RelPermalink }}" alt="Image for {{ $.Title }}" class="img_gadget project-list-image-square" />
                {{ else }}
                  <img src="{{ ($img_found.Resize "x180 q100").RelPermalink }}" alt="Image for {{ $.Title }}" class="img_gadget" />
                {{ end }}
              {{ else }}
                {{ $placeholder := resources.Get "images/project-placeholder.svg" }}
                {{ if $placeholder }}
                  <img src="{{ $placeholder.RelPermalink }}" alt="Placeholder for {{ $.Title }}" class="img_gadget project-list-image-svg" style="opacity: 0.7;" />
                {{ else }}
                  {{ $.Title }}
                {{ end }}
              {{ end }}
              <br />
            {{ end }}
            <br />
          </a>
        </center>
        <div class="project-links">
          {{ if .Params.website_url }}
            <a href="{{ .Params.website_url }}" target="_blank" rel="noopener" title="Website">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
            </a>
          {{ end }}
          {{ if .Params.github_url }}
            <a href="{{ .Params.github_url }}" target="_blank" rel="noopener" title="GitHub">
              {{ $githubIcon := resources.Get "images/github.svg" }}
              {{ if $githubIcon }}
                <img src="{{ $githubIcon.RelPermalink }}" alt="GitHub" style="width: 20px; height: 20px;" />
              {{ end }}
            </a>
          {{ end }}
        </div>
      </div>
    {{ end }}
    <div class="clear"></div>
  </div>
{{ end }}

<div class="clear"></div>

{{ partial "footer.html" . }}
