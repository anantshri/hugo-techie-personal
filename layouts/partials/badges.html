{{ $page := .page }}
{{ $params := . }}
{{ $size := $params.size | default "normal" }}
{{ $showExpiredOnly := eq ($params.show_expired | default "false") "true" }}
{{ $hideExpired := eq ($params.hide_expired | default "false") "true" }}
{{ $isSmall := eq $size "small" }}
{{ $isBig := eq $size "big" }}
{{ $isNormal := or (eq $size "normal") (and (ne $size "small") (ne $size "big")) }}
{{ $showCredly := ne ($params.show_credly | default "true") "false" }}
{{ $showAccredible := ne ($params.show_accredible | default "true") "false" }}
{{ $showManual := ne ($params.show_manual | default "true") "false" }}
{{ $showOpenBadges := ne ($params.show_openbadges | default "true") "false" }}
{{ $showBadgr := ne ($params.show_badgr | default "true") "false" }}
{{ $showBugcrowd := ne ($params.show_bugcrowd | default "true") "false" }}
{{ $showHackerone := ne ($params.show_hackerone | default "true") "false" }}

{{/* Collect all badges from all sources */}}
{{ $allBadges := slice }}

{{/* Fetch Credly badges */}}
{{ if $showCredly }}
  {{ $credlyUsername := $page.Site.Params.credly_username }}
  {{ $credlyImageDir := $page.Site.Params.credly_image_dir | default "images/CredlyBadges" }}
  
  {{ if $credlyUsername }}
    {{ $badgeUrl := printf "https://www.credly.com/users/%s/badges.json" $credlyUsername }}
    {{ $badgesData := false }}
    
    {{/* Try cached data first */}}
    {{ $cachedJson := resources.Get "data/CredlyBadges.json" }}
    {{ if $cachedJson }}
      {{ with try ($cachedJson.Content | transform.Unmarshal) }}
        {{ if not .Err }}
          {{ $badgesData = .Value }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{/* Try API */}}
    {{ with try (resources.GetRemote $badgeUrl) }}
      {{ if not .Err }}
        {{ $cachePath := "data/CredlyBadges.json" }}
        {{ $remoteResource := .Value }}
        {{ with resources.FromString $cachePath $remoteResource.Content }}
          {{ $copiedResource := . | resources.Copy $cachePath }}
          {{/* Resource cached - using with block prevents output */}}
        {{ end }}
        {{ with try ($remoteResource.Content | transform.Unmarshal) }}
          {{ if not .Err }}
            {{ $badgesData = .Value }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{/* Fallback to Site.Data */}}
    {{ if not $badgesData }}
      {{ $badgesData = $page.Site.Data.CredlyBadges }}
    {{ end }}
    
    {{ if $badgesData }}
      {{ $badges := $badgesData.data | default $badgesData }}
      {{ if $badges }}
        {{ range $badges }}
          {{ $expiresAt := .expires_at | default .ExpiresAt }}
          {{ $isExpired := false }}
          {{ if $expiresAt }}
            {{ $expireTime := time $expiresAt }}
            {{ if lt $expireTime now }}
              {{ $isExpired = true }}
            {{ end }}
          {{ end }}
          
          {{ $includeBadge := true }}
          {{ if $showExpiredOnly }}
            {{ if not $isExpired }}
              {{ $includeBadge = false }}
            {{ end }}
          {{ else if $hideExpired }}
            {{ if $isExpired }}
              {{ $includeBadge = false }}
            {{ end }}
          {{ end }}
          
          {{ if $includeBadge }}
            {{ $normalizedBadge := dict 
              "id" (.id | default .Id | string)
              "name" (.badge_template.name | default .Name)
              "description" (.badge_template.description | default .Description)
              "imageUrl" (.badge_template.image_url | default .RemoteImageUrl)
              "issuedAt" (.issued_at | default .IssuedAt)
              "expiresAt" $expiresAt
              "url" (printf "https://www.credly.com/badges/%s" (.id | default .Id | string))
              "imageDir" $credlyImageDir
              "isExpired" $isExpired
              "source" "credly"
            }}
            {{ $allBadges = $allBadges | append $normalizedBadge }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Fetch Accredible badges */}}
{{ if $showAccredible }}
  {{ $accredibleUsername := $page.Site.Params.accredible_username }}
  {{ $accredibleImageDir := $page.Site.Params.accredible_image_dir | default "images/AccredibleBadges" }}
  
  {{ if $accredibleUsername }}
    {{ $secretKey := "chtM@CyP_.7iF.kuQXBv" }}
    {{ $apiPath := printf "/v1/credential-net/users/%s/user_wallet" $accredibleUsername }}
    {{ $apiUrl := printf "https://api.accredible.com%s" $apiPath }}
    {{ $badgesData := false }}
    
    {{/* Try cached data first */}}
    {{ $cachedJson := resources.Get "data/AccredibleBadges.json" }}
    {{ if $cachedJson }}
      {{ with try ($cachedJson.Content | transform.Unmarshal) }}
        {{ if not .Err }}
          {{ $badgesData = .Value }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{/* Try API */}}
    {{ $timestamp := now.Unix | string }}
    {{ $message := printf "GET %s HTTP/1.1 %s" $apiPath $timestamp }}
    {{ $signature := hmac "sha256" $secretKey $message }}
    {{ $headers := dict "accept" "application/json, text/plain, */*" "x-signature" $signature "x-timestamp" $timestamp }}
    {{ with try (resources.GetRemote $apiUrl (dict "headers" $headers)) }}
      {{ if not .Err }}
        {{ $cachePath := "data/AccredibleBadges.json" }}
        {{ $remoteResource := .Value }}
        {{ with resources.FromString $cachePath $remoteResource.Content }}
          {{ $copiedResource := . | resources.Copy $cachePath }}
          {{/* Resource cached - using with block prevents output */}}
        {{ end }}
        {{ with try ($remoteResource.Content | transform.Unmarshal) }}
          {{ if not .Err }}
            {{ $badgesData = .Value }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{/* Fallback to Site.Data */}}
    {{ if not $badgesData }}
      {{ $badgesData = $page.Site.Data.AccredibleBadges }}
    {{ end }}
    
    {{ if $badgesData }}
      {{ $badges := $badgesData.data.credentials | default $badgesData.data | default $badgesData.credentials | default $badgesData }}
      {{ if $badges }}
        {{ range $badges }}
          {{ $expiresAt := .expires_at | default .expired_on | default .expires_on | default .ExpiresAt }}
          {{ $isExpired := false }}
          {{ if $expiresAt }}
            {{ $expireTime := time $expiresAt }}
            {{ if lt $expireTime now }}
              {{ $isExpired = true }}
            {{ end }}
          {{ end }}
          
          {{ $includeBadge := true }}
          {{ if $showExpiredOnly }}
            {{ if not $isExpired }}
              {{ $includeBadge = false }}
            {{ end }}
          {{ else if $hideExpired }}
            {{ if $isExpired }}
              {{ $includeBadge = false }}
            {{ end }}
          {{ end }}
          
          {{ if $includeBadge }}
            {{ $badgeImageUrl := .image_url | default .badge_image_url | default .credential_image_url | default .RemoteImageUrl }}
            {{ if not $badgeImageUrl }}
              {{ $svg := .group.badge_design.svg | default "" }}
              {{ if $svg }}
                {{ $matches := findRE `xlink:href="([^"]+)"` $svg }}
                {{ if $matches }}
                  {{ $fullMatch := index $matches 0 }}
                  {{ $badgeImageUrl = replace $fullMatch `xlink:href="` "" }}
                  {{ $badgeImageUrl = replace $badgeImageUrl `"` "" }}
                {{ end }}
              {{ end }}
            {{ end }}
            
            {{ $normalizedBadge := dict 
              "id" (.id | default .achievement_id | default .encoded_id | default .Id | string)
              "name" (.name | default .credential_name | default .title | default .Name | default "Unnamed Badge")
              "description" (.description | default .credential_description | default .Description)
              "imageUrl" $badgeImageUrl
              "issuedAt" (.issued_at | default .issued_on | default .created_at | default .IssuedAt)
              "expiresAt" $expiresAt
              "url" (.url | default .credential_url | default .AccredibleUrl | default (printf "https://www.accredible.com/credential/%s" (.encoded_id | default .id | default .achievement_id | string)))
              "imageDir" $accredibleImageDir
              "isExpired" $isExpired
              "source" "accredible"
            }}
            {{ $allBadges = $allBadges | append $normalizedBadge }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Fetch Manual badges */}}
{{ if $showManual }}
  {{ $manualBadges := partial "manual-badges.html" $params }}
  {{ if $manualBadges }}
    {{ range $manualBadges }}
      {{ $allBadges = $allBadges | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Fetch Open Badges */}}
{{ if $showOpenBadges }}
  {{ $openBadges := partial "openbadges-badges.html" $params }}
  {{ if $openBadges }}
    {{ range $openBadges }}
      {{ $allBadges = $allBadges | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Fetch Badgr badges */}}
{{ if $showBadgr }}
  {{ $badgrBadges := partial "badgr-badges.html" $params }}
  {{ if $badgrBadges }}
    {{ range $badgrBadges }}
      {{ $allBadges = $allBadges | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Fetch Bugcrowd badges */}}
{{ if $showBugcrowd }}
  {{ $bugcrowdBadges := partial "bugcrowd-badges.html" $params }}
  {{ if $bugcrowdBadges }}
    {{ range $bugcrowdBadges }}
      {{ $allBadges = $allBadges | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Fetch HackerOne badges */}}
{{ if $showHackerone }}
  {{ $hackeroneBadges := partial "hackerone-badges.html" $params }}
  {{ if $hackeroneBadges }}
    {{ range $hackeroneBadges }}
      {{ $allBadges = $allBadges | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Separate badges into expired and non-expired, then sort each group */}}
{{ $activeBadges := slice }}
{{ $expiredBadges := slice }}
{{ range $allBadges }}
  {{ if .isExpired }}
    {{ $expiredBadges = $expiredBadges | append . }}
  {{ else }}
    {{ $activeBadges = $activeBadges | append . }}
  {{ end }}
{{ end }}

{{/* Sort active badges by issued date (most recent first) */}}
{{ $sortedActiveBadges := sort $activeBadges "issuedAt" "desc" }}

{{/* Sort expired badges by issued date (most recent first) */}}
{{ $sortedExpiredBadges := sort $expiredBadges "issuedAt" "desc" }}

{{/* Combine: active badges first, then expired badges at the end */}}
{{ $sortedBadges := $sortedActiveBadges | append $sortedExpiredBadges }}

{{/* Render all badges in a single grid container */}}
{{ if $sortedBadges }}
  <div class="badges{{ if $isSmall }} badges-small{{ else if $isBig }} badges-big{{ else }} badges-normal{{ end }}">
    {{ range $sortedBadges }}
      {{ $badgeId := .id }}
      {{ $badgeName := .name }}
      {{ $badgeDescription := .description }}
      {{ $badgeImageUrl := .imageUrl }}
      {{ $issuedAt := .issuedAt }}
      {{ $expiresAt := .expiresAt }}
      {{ $badgeUrl := .url }}
      {{ $imageDir := .imageDir }}
      {{ $isExpired := .isExpired }}
      {{ $badgeSource := .source | default "" }}
      {{ $publisher := .publisher | default "" }}
      {{ $badgeIcon := .icon | default "" }}
      {{ $badgeKey := .badgeKey | default "" }}
      
      {{/* Download and store badge image in assets directory */}}
      {{ $badgeImage := "" }}
      
      {{/* First, check for local badge image (useful for Bugcrowd and other platforms without image URLs) */}}
      {{ $localImageExtensions := slice "svg" "png" "jpg" "jpeg" "gif" "webp" }}
      {{ range $localImageExtensions }}
        {{ $localImagePath := printf "%s/%s.%s" $imageDir $badgeId . }}
        {{ $localImage := resources.Get $localImagePath }}
        {{ if $localImage }}
          {{ $badgeImage = $localImage }}
          {{ break }}
        {{ end }}
      {{ end }}
      
      {{/* Also check for badgeKey-based local files (for Bugcrowd badges) */}}
      {{ if and (not $badgeImage) (eq $badgeSource "bugcrowd") $badgeKey }}
        {{ $badgeKeyPath := printf "%s/%s.svg" $imageDir $badgeKey }}
        {{ $badgeKeyImage := resources.Get $badgeKeyPath }}
        {{ if $badgeKeyImage }}
          {{ $badgeImage = $badgeKeyImage }}
        {{ end }}
      {{ end }}
      
      {{/* If no local image found and we have a URL, try to download */}}
      {{ if and (not $badgeImage) $badgeImageUrl }}
        {{/* Determine image extension from URL */}}
        {{ $imageExt := "png" }}
        {{ if findRE "\\.(jpg|jpeg|png|gif|webp)" $badgeImageUrl }}
          {{ $urlParts := split $badgeImageUrl "." }}
          {{ $imageExt = index $urlParts (sub (len $urlParts) 1) }}
        {{ end }}
        
        {{/* Construct asset path */}}
        {{ $assetPath := printf "%s/%s.%s" $imageDir $badgeId $imageExt }}
        
        {{/* Check if image already exists in assets (cached) */}}
        {{ $existingImage := resources.Get $assetPath }}
        
        {{ if $existingImage }}
          {{/* Use existing cached image from assets */}}
          {{ $badgeImage = $existingImage }}
        {{ else }}
          {{/* Download image using resources.GetRemote (gets highest resolution) */}}
          {{ with try (resources.GetRemote $badgeImageUrl) }}
            {{ with .Err }}
              {{ warnf "Error downloading badge image %s: %s" $badgeImageUrl . }}
            {{ else }}
              {{/* Copy remote resource to assets directory for caching */}}
              {{ $remoteImage := .Value }}
              {{ $copiedImage := $remoteImage | resources.Copy $assetPath }}
              {{ if $copiedImage }}
                {{ $badgeImage = $copiedImage }}
              {{ else }}
                {{/* Fallback to remote image if copy fails */}}
                {{ $badgeImage = $remoteImage }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
      
      <div class="badge{{ if $isExpired }} badge-expired{{ end }}{{ if $isSmall }} badge-small{{ else if $isBig }} badge-big{{ else }} badge-normal{{ end }}{{ if $badgeDescription }} badge-has-tooltip{{ end }}"{{ if and (not $isSmall) $badgeDescription }} data-tooltip="{{ $badgeDescription }}"{{ end }}>
        <a href="{{ $badgeUrl }}" target="_blank" rel="noopener noreferrer" class="badge-link" title="{{ $badgeName }}{{ if $badgeDescription }} - {{ $badgeDescription }}{{ end }}">
          {{ if $badgeIcon }}
            {{/* Display FontAwesome icon badge */}}
            <div class="badge-icon-container">
              <i class="{{ $badgeIcon }}" aria-hidden="true"></i>
            </div>
          {{ else if $badgeImage }}
            {{/* Check if image is SVG - SVGs can't be resized */}}
            {{ $isSvg := eq $badgeImage.MediaType.SubType "svg" }}
            {{ if $isSvg }}
              {{/* SVG files - display directly without resizing */}}
              <img src="{{ $badgeImage.RelPermalink }}" 
                   alt="{{ $badgeName }}" 
                   class="badge-image badge-image-svg" 
                   loading="lazy" />
            {{ else }}
              {{/* Raster images - use Hugo's image processing - resize based on size option */}}
              {{ if $isSmall }}
                {{ $processedImage := $badgeImage.Resize "64x64 q90" }}
                <img src="{{ $processedImage.RelPermalink }}" 
                     alt="{{ $badgeName }}" 
                     class="badge-image" 
                     loading="lazy" />
              {{ else if $isBig }}
                {{ $processedImage := $badgeImage.Resize "500x500 q90" }}
                <img src="{{ $processedImage.RelPermalink }}" 
                     srcset="{{ ($badgeImage.Resize "1000x1000 q90").RelPermalink }} 2x"
                     alt="{{ $badgeName }}" 
                     class="badge-image" 
                     loading="lazy" />
              {{ else }}
                {{/* Normal size: 250x250 */}}
                {{ $processedImage := $badgeImage.Resize "250x250 q90" }}
                <img src="{{ $processedImage.RelPermalink }}" 
                     srcset="{{ ($badgeImage.Resize "500x500 q90").RelPermalink }} 2x"
                     alt="{{ $badgeName }}" 
                     class="badge-image" 
                     loading="lazy" />
              {{ end }}
            {{ end }}
          {{ else }}
            <div class="badge-placeholder">Badge Image</div>
          {{ end }}
          {{ if not $isSmall }}
            <div class="badge-content">
              {{ if $badgeName }}
                <h3 class="badge-name">
                  {{ $badgeName }}
                </h3>
              {{ end }}
              <div class="badge-meta">
                {{ if $publisher }}
                  <span class="badge-publisher">{{ $publisher }}</span>
                {{ end }}
                {{ if $issuedAt }}
                  {{ $issueDate := time.Format "2 Jan 2006" (time $issuedAt) }}
                  {{ if $expiresAt }}
                    {{ $expireDate := time.Format "2 Jan 2006" (time $expiresAt) }}
                    <span class="badge-date{{ if $isExpired }} badge-expired-text{{ end }}">
                      {{ $issueDate }} - {{ $expireDate }}
                    </span>
                  {{ else }}
                    <span class="badge-date">
                      {{ $issueDate }}
                    </span>
                  {{ end }}
                {{ end }}
              </div>
            </div>
          {{ end }}
        </a>
      </div>
    {{ end }}
  </div>
{{ end }}

